{"version":3,"file":"request.js","sourceRoot":"","sources":["../src/request.ts"],"names":[],"mappings":"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","sourcesContent":["import { Base, BaseOptions, Headers } from './base'\r\nimport { Response } from './response'\r\nimport { splice } from './support'\r\nimport PopsicleError from './error'\r\n\r\nexport interface DefaultsOptions extends BaseOptions {\r\n  method?: string\r\n  timeout?: number\r\n  body?: any\r\n  use?: Middleware[]\r\n  transport?: TransportOptions\r\n}\r\n\r\nexport interface RequestOptions extends DefaultsOptions {\r\n  url: string\r\n  events?: Events\r\n}\r\n\r\nexport interface RequestJSON {\r\n  url: string\r\n  headers: Headers\r\n  body: any\r\n  timeout: number\r\n  method: string\r\n}\r\n\r\nexport interface Events {\r\n  abort: EventList<(this: Request) => void>\r\n  progress: EventList<(this: Request) => void>\r\n}\r\n\r\nexport interface TransportOptions {\r\n  open: (request: Request) => Promise<Response>\r\n  abort?: (request: Request) => any\r\n  use?: Middleware[]\r\n}\r\n\r\nexport type EventList <T extends (...args: any[]) => void> = Array<EventFn<T>>\r\nexport type EventFn <T extends (...args: any[]) => void> = T & { listener?: T }\r\nexport type Middleware = (request: Request, next: () => Promise<Response>) => Response | Promise<Response>\r\n\r\nexport class Request extends Base {\r\n  method: string\r\n  timeout: number\r\n  body: any\r\n  transport: TransportOptions\r\n  events: Events\r\n  middleware: Middleware[] = []\r\n\r\n  opened = false\r\n  aborted = false\r\n  uploaded = 0\r\n  downloaded = 0\r\n  uploadedBytes: number\r\n  downloadedBytes: number\r\n  uploadLength: number\r\n  downloadLength: number\r\n\r\n  _raw: any\r\n  _promise: Promise<Response>\r\n\r\n  constructor (options: RequestOptions) {\r\n    super(options)\r\n\r\n    this.timeout = (options.timeout || 0)\r\n    this.method = (options.method || 'GET').toUpperCase()\r\n    this.body = options.body\r\n    this.events = options.events || Object.create(null)\r\n\r\n    // Extend to avoid mutations of the transport object.\r\n    this.transport = Object.assign({}, options.transport)\r\n\r\n    var optionsUse: Middleware[] = options.use as Middleware[]\r\n    var transportUse: Middleware[] = this.transport.use as Middleware[]\r\n\r\n    // Automatically `use` default middleware functions.\r\n    this.use(optionsUse || transportUse)\r\n\r\n    // External promise representation, resolves _after_ middleware has been\r\n    // attached by relying on promises always resolving on the \"next tick\".\r\n    this._promise = Promise.resolve().then(() => exec(this))\r\n\r\n    // Attach an abort listener.\r\n    this.once('abort', () => {\r\n      if (this.completed === 1) {\r\n        return\r\n      }\r\n\r\n      this.aborted = true\r\n    })\r\n  }\r\n\r\n  error (message: string, code: string, original?: Error): PopsicleError {\r\n    return new PopsicleError(message, code, original as Error, this)\r\n  }\r\n\r\n  then <T> (\r\n    onFulfilled?: (response: Response) => T | PromiseLike<T>,\r\n    onRejected?: (error: PopsicleError) => T | PromiseLike<T>\r\n  ): Promise<T> {\r\n    return this._promise.then(onFulfilled, onRejected)\r\n  }\r\n\r\n  catch <T> (onRejected: (error: PopsicleError) => T): Promise<T | Response> {\r\n    return this._promise.then(null, onRejected)\r\n  }\r\n\r\n  exec (cb: (error: PopsicleError | null, response?: Response) => void) {\r\n    void this.then(res => cb(null, res), cb)\r\n  }\r\n\r\n  toOptions (): RequestOptions {\r\n    return {\r\n      url: this.url,\r\n      method: this.method,\r\n      body: this.body,\r\n      transport: this.transport,\r\n      timeout: this.timeout,\r\n      rawHeaders: this.rawHeaders,\r\n      use: this.middleware,\r\n      events: this.events\r\n    }\r\n  }\r\n\r\n  toJSON (): RequestJSON {\r\n    return {\r\n      url: this.url,\r\n      method: this.method,\r\n      headers: this.headers,\r\n      body: this.body,\r\n      timeout: this.timeout\r\n    }\r\n  }\r\n\r\n  clone () {\r\n    return new Request(this.toOptions())\r\n  }\r\n\r\n  use (fn: Middleware | Middleware[]) {\r\n    if (Array.isArray(fn)) {\r\n      this.middleware.push(...fn)\r\n    } else {\r\n      this.middleware.push(fn)\r\n    }\r\n\r\n    return this\r\n  }\r\n\r\n  on (event: keyof Events, fn: (this: this, ...args: any[]) => void) {\r\n    if (Object.prototype.hasOwnProperty.call(this.events, event)) {\r\n      this.events[event].push(fn)\r\n    } else {\r\n      this.events[event] = [fn]\r\n    }\r\n\r\n    return this\r\n  }\r\n\r\n  off (event: keyof Events, fn: (this: this, ...args: any[]) => void) {\r\n    if (Object.prototype.hasOwnProperty.call(this.events, event)) {\r\n      const list = this.events[event]\r\n      let index = -1\r\n\r\n      for (let i = 0; i < list.length; i++) {\r\n        if (list[i] === fn || list[i].listener === fn) {\r\n          index = i\r\n          break\r\n        }\r\n      }\r\n\r\n      if (index > -1) {\r\n        if (list.length === 1) {\r\n          delete this.events[event]\r\n        } else {\r\n          splice(this.events[event], index)\r\n        }\r\n      }\r\n    }\r\n\r\n    return this\r\n  }\r\n\r\n  once (event: keyof Events, fn: (this: this, ...args: any[]) => void) {\r\n    return this.on(event, wrapOnce(this, event, fn))\r\n  }\r\n\r\n  emit (event: keyof Events, ...args: any[]) {\r\n    if (!Object.prototype.hasOwnProperty.call(this.events, event)) {\r\n      return this\r\n    }\r\n\r\n    const listeners = this.events[event]\r\n\r\n    if (listeners.length === 1) {\r\n      args.length === 0 ? listeners[0].call(this) : listeners[0].apply(this, args)\r\n    } else {\r\n      for (const listener of listeners.slice()) {\r\n        args.length === 0 ? listener.call(this) : listener.apply(this, args)\r\n      }\r\n    }\r\n\r\n    return this\r\n  }\r\n\r\n  abort () {\r\n    return this.emit('abort')\r\n  }\r\n\r\n  handle () {\r\n    this.opened = true\r\n\r\n    // Catch URLs that will cause the request to hang indefinitely in\r\n    // CORS disabled environments. E.g. Atom Editor.\r\n    if (/^https?\\:\\/*(?:[~#\\\\\\?;\\:]|$)/.test(this.url)) {\r\n      return Promise.reject(this.error(`Refused to connect to invalid URL \"${this.url}\"`, 'EINVALID'))\r\n    }\r\n\r\n    const { timeout } = this\r\n    let timer: any\r\n\r\n    // Resolve the transport request with timeout rejection.\r\n    const result = new Promise<Response>((resolve, reject) => {\r\n      if (timeout > 0) {\r\n        timer = setTimeout(\r\n          () => {\r\n            // Reject _before_ aborting the request.\r\n            reject(this.error(`Timeout of ${timeout}ms exceeded`, 'ETIMEOUT'))\r\n\r\n            // Abort the transport layer.\r\n            this.abort()\r\n          },\r\n          timeout\r\n        )\r\n      }\r\n\r\n      this.once('abort', () => {\r\n        // Emit a final progress event.\r\n        this.emit('progress')\r\n\r\n        // Reject _before_ aborting the request (which may `resolve`).\r\n        reject(this.error('Request aborted', 'EABORT'))\r\n\r\n        // Pass the abort onto the transport layer.\r\n        if (this.transport.abort) {\r\n          this.transport.abort(this)\r\n        }\r\n      })\r\n\r\n      // Wrap the transport layer to defer resolving the outer promise, allows\r\n      // other conditions to possibly `reject` over the transport layer.\r\n      void Promise.resolve(this.transport.open(this)).then(\r\n        (res) => resolve(res),\r\n        (err) => reject(err)\r\n      )\r\n    })\r\n\r\n    // Clear the timeout on resolve, if enabled.\r\n    if (timeout > 0) {\r\n      void result.then(\r\n        () => clearTimeout(timer),\r\n        () => clearTimeout(timer)\r\n      )\r\n    }\r\n\r\n    return result\r\n  }\r\n\r\n  get completed () {\r\n    return (this.uploaded + this.downloaded) / 2\r\n  }\r\n\r\n  get completedBytes () {\r\n    return this.uploadedBytes + this.downloadedBytes\r\n  }\r\n\r\n  get totalBytes () {\r\n    return this.uploadLength + this.downloadLength\r\n  }\r\n\r\n  _setUploadedBytes (bytes: number, uploaded?: number) {\r\n    if (bytes !== this.uploadedBytes) {\r\n      this.uploaded = uploaded || bytes / this.uploadLength\r\n      this.uploadedBytes = bytes\r\n      this.emit('progress')\r\n    }\r\n  }\r\n\r\n  _setDownloadedBytes (bytes: number, downloaded?: number) {\r\n    if (bytes !== this.downloadedBytes) {\r\n      this.downloaded = downloaded || bytes / this.downloadLength\r\n      this.downloadedBytes = bytes\r\n      this.emit('progress')\r\n    }\r\n  }\r\n\r\n}\r\n\r\n/**\r\n * Create a `once` function wrapper.\r\n */\r\nfunction wrapOnce (target: Request, event: keyof Events, fn: (...args: any[]) => void) {\r\n  let fired = false\r\n\r\n  const g: EventFn<typeof fn> = (...args: any[]) => {\r\n    if (!fired) {\r\n      fired = true\r\n      target.off(event, fn)\r\n      args.length === 0 ? fn.call(target) : fn.apply(target, args)\r\n    }\r\n  }\r\n\r\n  g.listener = fn\r\n\r\n  return g\r\n}\r\n\r\n/**\r\n * Compose the API request with middleware.\r\n */\r\nfunction exec (req: Request) {\r\n  let index = -1\r\n\r\n  function dispatch (pos: number): Promise<Response> {\r\n    if (pos <= index) {\r\n      throw new TypeError('`next()` called multiple times')\r\n    }\r\n\r\n    // Avoid proceeding when the request was aborted.\r\n    if (req.aborted) {\r\n      return Promise.reject(req.error('Request aborted', 'EABORT'))\r\n    }\r\n\r\n    index = pos\r\n\r\n    const fn = req.middleware[pos] || (() => req.handle())\r\n\r\n    return new Promise<Response>(resolve => {\r\n      return resolve(fn(req, function next () {\r\n        return dispatch(pos + 1)\r\n      }))\r\n    })\r\n  }\r\n\r\n  return dispatch(0)\r\n}\r\n"]}